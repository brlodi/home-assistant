# Since we need more than one switch to fully control the Roku TV we combine all
# the elements under a Universal Media Player component so it looks like a
# single entity again.
platform: universal
name: Living Room
children:
  - media_player.roku_tv_living_room
# This requires a very complicated state template, described as follows:
#   - if the TV template switch is 'on':
#     - if the Roku TV state is 'home' or 'idle', system is Idle
#     - if the Roku TV source is 'Xbox One':
#       - if the Xbox Live sensor is 'Offline' or 'Online', the system is Idle
#       - otherwise, the system displays the Xbox Live sensor status (i.e. the active Xbox media)
#     - otherwise, the system displays the Roku TV's state
#   - otherwise, the system is Off
state_template: >-
  {% if is_state('switch.roku_tv_living_room', 'on') %}
    {% if is_state('media_player.roku_tv_living_room', 'home') or is_state('media_player.roku_tv_living_room', 'idle') %}
      idle
    {% elif is_state_attr('media_player.roku_tv_living_room', 'source', 'Xbox One') %}
      {% if is_state('sensor.xbox_live_ben', 'Offline') or is_state('sensor.xbox_live_ben', 'Online') %}
        idle
      {% else %}
        {{ states('sensor.xbox_live_ben') }}
      {% endif %}
    {% else %}   
      {{ states('media_player.roku_tv_living_room') }}
    {% endif %}
  {% else %}
    off
  {% endif %}
attributes:
  source: media_player.roku_tv_living_room|source
  source_list: media_player.roku_tv_living_room|source_list
commands:
  turn_on:
    service: switch.turn_on
    data:
      entity_id: switch.roku_tv_living_room
  turn_off:
    service: switch.turn_off
    data:
      entity_id: switch.roku_tv_living_room
  volume_up:
    service: rest_command.roku_keypress
    data:
      host: 10.0.0.20
      key: VolumeUp
  volume_down:
    service: rest_command.roku_keypress
    data:
      host: 10.0.0.20
      key: VolumeDown
  volume_mute:
    service: rest_command.roku_keypress
    data:
      host: 10.0.0.20
      key: VolumeMute
  select_source:
    service: media_player.select_source
    data_template:
      entity_id: media_player.roku_tv_living_room
      source: '{{ source }}'
